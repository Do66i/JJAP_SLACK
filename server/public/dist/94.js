"use strict";(self.webpackChunkalecture=self.webpackChunkalecture||[]).push([[94],{3094:function(e,t,n){n.r(t),n.d(t,{default:function(){return Z}});var r=n(2309),a=n(2545),o=n(8678),l=n(2951),c=n(9732),i=n(6482),u=(0,i.Z)("div",{target:"enpw7kx2"})({name:"1a0r0eh",styles:"display:flex;flex-wrap:wrap;height:calc(100vh - 38px);flex-flow:column;position:relative"}),s=(0,i.Z)("header",{target:"enpw7kx1"})({name:"1c17pcy",styles:"height:64px;display:flex;width:100%;--saf-0:rgba(var(--sk_foreground_low, 29, 28, 29), 0.13);box-shadow:0 1px 0 var(--saf-0);padding:20px 16px 20px 20px;font-weight:bold;align-items:center;& img{margin-right:5px;}"}),f=((0,i.Z)("div",{target:"enpw7kx0"})({name:"czjct4",styles:"position:absolute;top:64px;left:0;width:100%;height:calc(100% - 64px);background:white;opacity:0.7;display:flex;align-items:center;justify-content:center;font-size:40px"}),n(3564)),d=n(8667),m=n(9669),p=n.n(m),g=n(6182),h=n.n(g),v=n(7294),y=n(6974),b=n(6042),w=n(8100),S=n(4593);function k(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,o=[],l=!0,c=!1;try{for(n=n.call(e);!(l=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);l=!0);}catch(e){c=!0,a=e}finally{try{l||null==n.return||n.return()}finally{if(c)throw a}}return o}}(e,t)||x(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function x(e,t){if(e){if("string"==typeof e)return T(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?T(e,t):void 0}}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Z=function(){var e,t,n,i=(0,y.UO)(),m=i.workspace,g=i.id,Z=k((0,l.Z)(m),1)[0],A=(0,w.ZP)("/api/users",f.Z).data,C=(0,w.ZP)("/api/workspaces/".concat(m,"/users/").concat(g),f.Z).data,E=(0,S.ZP)((function(e){return"/api/workspaces/".concat(m,"/dms/").concat(g,"/chats?perPage=").concat(20,"&page=").concat(e+1)}),f.Z,{onSuccess:function(e){1===(null==e?void 0:e.length)&&setTimeout((function(){var e;null===(e=P.current)||void 0===e||e.scrollToBottom()}),100)}}),I=E.data,D=E.mutate,j=E.setSize,O=k((0,o.Z)(""),3),R=O[0],z=O[1],B=O[2],P=(0,v.useRef)(null),F=k((0,v.useState)(!1),2),H=F[0],M=F[1],N=0===(null==I||null===(e=I[0])||void 0===e?void 0:e.length)||I&&(null===(t=I[I.length-1])||void 0===t?void 0:t.length)<20,U=(0,v.useCallback)((function(e){if(e.preventDefault(),null!=R&&R.trim()&&I){var t=R;D((function(e){var n;return null==e||e[0].unshift({id:((null===(n=I[0][0])||void 0===n?void 0:n.id)||0)+1,content:t,SenderId:A.id,Sender:A,ReceiverId:C.id,Receiver:C,createdAt:new Date}),e}),!1).then((function(){localStorage.setItem("".concat(m,"-").concat(g),(new Date).getTime().toString()),B(""),P.current&&P.current.scrollToBottom()})),p().post("/api/workspaces/".concat(m,"/dms/").concat(g,"/chats"),{content:R}).catch(console.error)}}),[R,m,g,A,C,I,D,B]),_=(0,v.useCallback)((function(e){e.SenderId===Number(g)&&(null==A?void 0:A.id)!==Number(g)&&D((function(t){return null==t||t[0].unshift(e),t}),!1).then((function(){P.current&&(P.current.getScrollHeight()<P.current.getClientHeight()+P.current.getScrollTop()+150?setTimeout((function(){var e;null===(e=P.current)||void 0===e||e.scrollToBottom()}),100):b.Am.success("새 메시지가 도착했습니다.",{onClick:function(){var e;null===(e=P.current)||void 0===e||e.scrollToBottom()},closeOnClick:!0}))}))}),[g,A,D]);(0,v.useEffect)((function(){return null==Z||Z.on("dm",_),function(){null==Z||Z.off("dm",_)}}),[Z,_]),(0,v.useEffect)((function(){localStorage.setItem("".concat(m,"-").concat(g),(new Date).getTime().toString())}),[m,g]);var K=(0,v.useCallback)((function(e){e.preventDefault();var t=new FormData;if(e.dataTransfer.items){for(var n=0;n<e.dataTransfer.items.length;n++)if("file"===e.dataTransfer.items[n].kind){var r=e.dataTransfer.items[n].getAsFile();t.append("image",r)}}else for(var a=0;a<e.dataTransfer.files.length;a++)t.append("image",e.dataTransfer.files[a]);p().post("/api/workspaces/".concat(m,"/dms/").concat(g,"/images"),t).then((function(){M(!1),localStorage.setItem("".concat(m,"-").concat(g),(new Date).getTime().toString()),D()}))}),[m,g,D]),W=(0,v.useCallback)((function(e){e.preventDefault(),M(!0)}),[]);if(!C||!A)return null;var $,q=(0,d.Z)(I?(n=[]).concat.apply(n,($=I,function(e){if(Array.isArray(e))return T(e)}($)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}($)||x($)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())).reverse():[]);return v.createElement(u,{onDrop:K,onDragOver:W},v.createElement(s,null,v.createElement("img",{src:h().url(C.email,{s:"24px",d:"retro"}),alt:C.nickname}),v.createElement("span",null,C.nickname)),v.createElement(a.Z,{scrollRef:P,isReachingEnd:N,chatSections:q,setSize:j}),v.createElement(r.Z,{onSubmitForm:U,chat:R,onChangeChat:z,placeholder:"Message ".concat(C.nickname)}),H&&v.createElement(c.KW,null,"업로드!"))}}}]);